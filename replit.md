# Baileys - WhatsApp Web Library (Custom Fork)

## Overview

Custom fork of WhiskeySockets/Baileys — a TypeScript/Node.js library for interacting with WhatsApp Web via WebSockets. Extended with production-grade utilities for building bots.

## Tech Stack

- **Language**: TypeScript
- **Runtime**: Node.js >= 20
- **Package Manager**: npm
- **Build**: `tsc` with `tsc-esm-fix` (ESM output)

## Project Structure

```
src/
  Socket/         Core socket layer (messages, groups, chats, communities, newsletters)
  Utils/          Utilities — includes all custom additions
  Types/          TypeScript types
  Signal/         E2E encryption (Signal protocol)
  WABinary/       WhatsApp binary XML encoding/decoding
  WAUSync/        USync protocol (contact/device sync)
  Defaults/       Config defaults
Example/
  example.ts      Original QR-code connection example
  bot-example.ts  Full bot demo using all custom utilities
WAProto/          Protobuf definitions
lib/              Compiled output (generated by build)
```

## Scripts

```bash
npm run build          # Compile TypeScript -> lib/
npm run example        # Run original connection example
npm run example:bot    # Run full-featured bot example
npm run server         # Run REST API server (port 3000)
```

## Project Structure (updated)

```
src/
  Socket/         Core socket layer (messages, groups, chats, communities)
  Utils/          Utilities — all custom additions
    rate-limiter.ts     Anti-ban queue
    flow.ts             Conversation state machine
    webhook.ts          HTTP event forwarding
    scheduler.ts        Timed/recurring messages
    auto-reply.ts       Keyword auto-replies
    broadcast-list.ts   Bulk messaging
    session-manager.ts  Multi-session lifecycle manager
  Server/
    api.ts              REST API (~30 endpoints, native http module)
  Types/          TypeScript types
  Defaults/       Config defaults
Example/
  example.ts      Original QR connection demo
  bot-example.ts  Full bot demo (all utilities)
  server.ts       REST API server entry point
```

---

## Custom Features (this fork)

### 1. `RateLimitedQueue` — Anti-ban message queue
**File:** `src/Utils/rate-limiter.ts`

Queues all outgoing messages with configurable rate limits, random jitter, and per-recipient delays. Prevents WhatsApp bans from bulk sending.

```ts
import { RateLimitedQueue } from 'baileys'

const queue = new RateLimitedQueue({
  messagesPerMinute: 15,
  messagesPerDay: 300,
  minDelayMs: 1000,
  maxDelayMs: 3500,
  jitterMs: 500,
  onDailyLimitReached: jid => console.warn('Daily limit hit for', jid)
})

// Wrap sendMessage
const safeSend = (jid, content) => queue.enqueue(jid, () => sock.sendMessage(jid, content))

// Check stats
console.log(queue.stats) // { sentToday, sentThisMinute, queueDepth, ... }
```

### 2. `FlowManager` — Multi-step conversation flows
**File:** `src/Utils/flow.ts`

State-machine based conversation system. Each user gets their own session with state, timeouts, and step transitions.

```ts
import { FlowManager } from 'baileys'

const flows = new FlowManager((jid, content, quoted) => safeSend(jid, content, { quoted }))

flows.registerFlow({
  id: 'register',
  initialStep: 'ask_name',
  timeoutMs: 5 * 60 * 1000,
  steps: {
    ask_name: {
      onEnter: () => ({ send: { text: 'What is your name?' } }),
      onMessage: ctx => ({
        setState: { name: ctx.text },
        send: ctx => ({ text: `Hi ${ctx.state.name}! What is your email?` }),
        next: 'ask_email'
      })
    },
    ask_email: {
      onMessage: ctx => ({
        setState: { email: ctx.text },
        send: ctx => ({ text: `Registered: ${ctx.state.name} <${ctx.state.email}>` }),
        end: true
      })
    }
  }
})

// In message handler:
if (flows.hasActiveSession(jid)) await flows.process(msg)
else if (text === 'register') await flows.startFlow('register', jid, msg)
```

### 3. `WebhookBridge` — HTTP event forwarding
**File:** `src/Utils/webhook.ts`

Forwards WhatsApp events to HTTP endpoints with automatic retries and exponential backoff.

```ts
import { WebhookBridge } from 'baileys'

const webhook = new WebhookBridge()
webhook
  .addEndpoint('main', {
    url: 'https://your-server.com/whatsapp',
    secret: 'my-secret',
    events: ['messages.upsert', 'group-participants.update']
  })
  .attach(sock.ev)
```

Payload format:
```json
{
  "event": "messages.upsert",
  "data": { ... },
  "timestamp": 1234567890,
  "webhookId": "wh_abc123"
}
```

### 4. `MessageScheduler` — Timed & recurring messages
**File:** `src/Utils/scheduler.ts`

```ts
import { MessageScheduler } from 'baileys'

const scheduler = new MessageScheduler(sock.sendMessage)

// One-time delay
scheduler.scheduleIn(jid, { text: 'Reminder!' }, 60 * 60 * 1000)

// Daily at 9am
scheduler.scheduleRecurring(jid, { text: 'Good morning!' }, { type: 'daily', hour: 9 })
```

### 5. `AutoReplyManager` — Keyword-based auto replies
**File:** `src/Utils/auto-reply.ts`

```ts
import { AutoReplyManager } from 'baileys'

const bot = new AutoReplyManager(
  (jid, content, quoted) => sock.sendMessage(jid, content, { quoted }),
  (jid, typing) => sock.sendPresenceUpdate(typing ? 'composing' : 'paused', jid)
)

bot.addRule({
  id: 'hello',
  trigger: { type: 'regex', value: /^(hi|hello)$/i },
  condition: { cooldownMs: 10_000 },
  action: { reply: { text: 'Hey there!' }, typing: true, typingDelayMs: 800 }
})

sock.ev.on('messages.upsert', async ({ messages }) => {
  for (const msg of messages) await bot.process(msg)
})
```

### 6. `BroadcastListManager` — Bulk messaging
**File:** `src/Utils/broadcast-list.ts`

```ts
import { BroadcastListManager } from 'baileys'

const bcast = new BroadcastListManager(sock.sendMessage)
const list = bcast.createList('VIPs', [{ jid: 'jid@s.whatsapp.net' }])
const results = await bcast.broadcast(list.id, { text: 'Announcement!' }, {
  delayBetweenMs: 1500,
  onProgress: (r, i, total) => console.log(`${i}/${total}`)
})
```

### 7. New `sock` methods

| Method | Description |
|--------|-------------|
| `sendReaction(jid, key, emoji)` | React to a message |
| `removeReaction(jid, key)` | Remove a reaction |
| `forwardMessages(jid, messages)` | Bulk forward messages |
| `sendAlbumMessage(jid, mediaList)` | Send multiple images/videos |
| `sendTyping(jid, durationMs?)` | Show typing indicator |
| `sendStatusStory(content, recipientList?)` | Post a WhatsApp story |
| `pinMessage(jid, key, time?)` | Pin a message (default 7 days) |
| `unpinMessage(jid, key)` | Unpin a message |
| `groupGetInviteLink(jid)` | Get full `chat.whatsapp.com/…` link |
| `groupBulkParticipantsUpdate(jid, participants, action, onProgress?)` | Bulk admin operations |
| `groupGetAllAdmins(jid)` | List group admins |

---

### 8. `SessionManager` — Multi-session lifecycle manager
**File:** `src/Utils/session-manager.ts`

Manages multiple simultaneous WhatsApp connections. Auth state persisted per session under `./sessions/{id}/`. Automatic reconnect with exponential backoff.

```ts
import { SessionManager } from 'baileys'

const manager = new SessionManager({
  authDir: './sessions',
  autoReconnect: true,
  maxReconnectAttempts: 5,
  onMessage: (sessionId, msg) => console.log(sessionId, msg)
})

manager.on('session.qr', (id, qr) => console.log('Scan QR for', id))
manager.on('session.connected', (id, phone) => console.log(id, 'connected as', phone))

await manager.createSession('bot-1')
const sock = manager.getSocket('bot-1')
```

Session statuses: `initializing → qr_ready → connected` (or `disconnected / logged_out`)

---

### 9. `ApiServer` — REST API gateway
**File:** `src/Server/api.ts`  
**Entry point:** `Example/server.ts` (`npm run server`)

HTTP REST API over the native `node:http` module. Exposes ~30 endpoints for multi-session WhatsApp control. Optional API key auth via `X-API-Key` header or `Authorization: Bearer`.

**Environment variables:**
| Variable | Default | Description |
|----------|---------|-------------|
| `PORT` | `3000` | Listen port |
| `HOST` | `localhost` | Listen host |
| `API_KEY` | _(none)_ | Optional auth key |

**Endpoint reference:**

| Method | Path | Body / Notes |
|--------|------|-------------|
| `GET` | `/health` | Uptime + session count |
| `GET` | `/sessions` | List all sessions |
| `POST` | `/sessions` | `{ id }` — create session |
| `GET` | `/sessions/:id` | Status + QR string |
| `DELETE` | `/sessions/:id` | Destroy session |
| `POST` | `/sessions/:id/messages/text` | `{ jid, text }` |
| `POST` | `/sessions/:id/messages/media` | `{ jid, url, type, caption? }` |
| `POST` | `/sessions/:id/messages/react` | `{ jid, messageId, emoji }` |
| `POST` | `/sessions/:id/messages/forward` | `{ toJid, message }` |
| `POST` | `/sessions/:id/messages/delete` | `{ jid, messageId }` |
| `POST` | `/sessions/:id/messages/read` | `{ jid, messageIds[] }` |
| `POST` | `/sessions/:id/messages/pin` | `{ jid, messageId, time?, unpin? }` |
| `POST` | `/sessions/:id/presence` | `{ presence, jid? }` |
| `POST` | `/sessions/:id/status` | `{ text }` — WhatsApp story |
| `POST` | `/sessions/:id/groups` | `{ subject, participants[] }` |
| `GET` | `/sessions/:id/groups/:gid` | Group metadata |
| `POST` | `/sessions/:id/groups/:gid/participants` | `{ participants[], action }` |
| `GET` | `/sessions/:id/groups/:gid/invite` | Invite link |
| `PUT` | `/sessions/:id/groups/:gid/subject` | `{ subject }` |
| `PUT` | `/sessions/:id/groups/:gid/description` | `{ description? }` |
| `PUT` | `/sessions/:id/groups/:gid/settings` | `{ setting }` |
| `DELETE` | `/sessions/:id/groups/:gid/leave` | Leave group |
| `PUT` | `/sessions/:id/profile/name` | `{ name }` |
| `PUT` | `/sessions/:id/profile/status` | `{ status }` |
| `GET` | `/sessions/:id/profile/:jid` | Business profile |
| `POST` | `/sessions/:id/contacts/check` | `{ phones[] }` |
| `POST` | `/sessions/:id/contacts/block` | `{ jid, action }` |
| `POST` | `/sessions/:id/chats/:jid/archive` | `{ archive }` |
| `POST` | `/sessions/:id/chats/:jid/mute` | `{ mute, muteEndTime? }` |
