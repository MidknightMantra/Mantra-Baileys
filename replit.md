# Baileys - WhatsApp Web Library (Custom Fork)

## Overview

Custom fork of WhiskeySockets/Baileys — a TypeScript/Node.js library for interacting with WhatsApp Web via WebSockets. Extended with production-grade utilities for building bots.

## Tech Stack

- **Language**: TypeScript
- **Runtime**: Node.js >= 20
- **Package Manager**: npm
- **Build**: `tsc` with `tsc-esm-fix` (ESM output)

## Project Structure

```
src/
  Socket/         Core socket layer (messages, groups, chats, communities, newsletters)
  Utils/          Utilities — includes all custom additions
  Types/          TypeScript types
  Signal/         E2E encryption (Signal protocol)
  WABinary/       WhatsApp binary XML encoding/decoding
  WAUSync/        USync protocol (contact/device sync)
  Defaults/       Config defaults
Example/
  example.ts      Original QR-code connection example
  bot-example.ts  Full bot demo using all custom utilities
WAProto/          Protobuf definitions
lib/              Compiled output (generated by build)
```

## Scripts

```bash
npm run build          # Compile TypeScript -> lib/
npm run example        # Run original connection example
npm run example:bot    # Run full-featured bot example
```

---

## Custom Features (this fork)

### 1. `RateLimitedQueue` — Anti-ban message queue
**File:** `src/Utils/rate-limiter.ts`

Queues all outgoing messages with configurable rate limits, random jitter, and per-recipient delays. Prevents WhatsApp bans from bulk sending.

```ts
import { RateLimitedQueue } from 'baileys'

const queue = new RateLimitedQueue({
  messagesPerMinute: 15,
  messagesPerDay: 300,
  minDelayMs: 1000,
  maxDelayMs: 3500,
  jitterMs: 500,
  onDailyLimitReached: jid => console.warn('Daily limit hit for', jid)
})

// Wrap sendMessage
const safeSend = (jid, content) => queue.enqueue(jid, () => sock.sendMessage(jid, content))

// Check stats
console.log(queue.stats) // { sentToday, sentThisMinute, queueDepth, ... }
```

### 2. `FlowManager` — Multi-step conversation flows
**File:** `src/Utils/flow.ts`

State-machine based conversation system. Each user gets their own session with state, timeouts, and step transitions.

```ts
import { FlowManager } from 'baileys'

const flows = new FlowManager((jid, content, quoted) => safeSend(jid, content, { quoted }))

flows.registerFlow({
  id: 'register',
  initialStep: 'ask_name',
  timeoutMs: 5 * 60 * 1000,
  steps: {
    ask_name: {
      onEnter: () => ({ send: { text: 'What is your name?' } }),
      onMessage: ctx => ({
        setState: { name: ctx.text },
        send: ctx => ({ text: `Hi ${ctx.state.name}! What is your email?` }),
        next: 'ask_email'
      })
    },
    ask_email: {
      onMessage: ctx => ({
        setState: { email: ctx.text },
        send: ctx => ({ text: `Registered: ${ctx.state.name} <${ctx.state.email}>` }),
        end: true
      })
    }
  }
})

// In message handler:
if (flows.hasActiveSession(jid)) await flows.process(msg)
else if (text === 'register') await flows.startFlow('register', jid, msg)
```

### 3. `WebhookBridge` — HTTP event forwarding
**File:** `src/Utils/webhook.ts`

Forwards WhatsApp events to HTTP endpoints with automatic retries and exponential backoff.

```ts
import { WebhookBridge } from 'baileys'

const webhook = new WebhookBridge()
webhook
  .addEndpoint('main', {
    url: 'https://your-server.com/whatsapp',
    secret: 'my-secret',
    events: ['messages.upsert', 'group-participants.update']
  })
  .attach(sock.ev)
```

Payload format:
```json
{
  "event": "messages.upsert",
  "data": { ... },
  "timestamp": 1234567890,
  "webhookId": "wh_abc123"
}
```

### 4. `MessageScheduler` — Timed & recurring messages
**File:** `src/Utils/scheduler.ts`

```ts
import { MessageScheduler } from 'baileys'

const scheduler = new MessageScheduler(sock.sendMessage)

// One-time delay
scheduler.scheduleIn(jid, { text: 'Reminder!' }, 60 * 60 * 1000)

// Daily at 9am
scheduler.scheduleRecurring(jid, { text: 'Good morning!' }, { type: 'daily', hour: 9 })
```

### 5. `AutoReplyManager` — Keyword-based auto replies
**File:** `src/Utils/auto-reply.ts`

```ts
import { AutoReplyManager } from 'baileys'

const bot = new AutoReplyManager(
  (jid, content, quoted) => sock.sendMessage(jid, content, { quoted }),
  (jid, typing) => sock.sendPresenceUpdate(typing ? 'composing' : 'paused', jid)
)

bot.addRule({
  id: 'hello',
  trigger: { type: 'regex', value: /^(hi|hello)$/i },
  condition: { cooldownMs: 10_000 },
  action: { reply: { text: 'Hey there!' }, typing: true, typingDelayMs: 800 }
})

sock.ev.on('messages.upsert', async ({ messages }) => {
  for (const msg of messages) await bot.process(msg)
})
```

### 6. `BroadcastListManager` — Bulk messaging
**File:** `src/Utils/broadcast-list.ts`

```ts
import { BroadcastListManager } from 'baileys'

const bcast = new BroadcastListManager(sock.sendMessage)
const list = bcast.createList('VIPs', [{ jid: 'jid@s.whatsapp.net' }])
const results = await bcast.broadcast(list.id, { text: 'Announcement!' }, {
  delayBetweenMs: 1500,
  onProgress: (r, i, total) => console.log(`${i}/${total}`)
})
```

### 7. New `sock` methods

| Method | Description |
|--------|-------------|
| `sendReaction(jid, key, emoji)` | React to a message |
| `removeReaction(jid, key)` | Remove a reaction |
| `forwardMessages(jid, messages)` | Bulk forward messages |
| `sendAlbumMessage(jid, mediaList)` | Send multiple images/videos |
| `sendTyping(jid, durationMs?)` | Show typing indicator |
| `sendStatusStory(content, recipientList?)` | Post a WhatsApp story |
| `pinMessage(jid, key, time?)` | Pin a message (default 7 days) |
| `unpinMessage(jid, key)` | Unpin a message |
| `groupGetInviteLink(jid)` | Get full `chat.whatsapp.com/…` link |
| `groupBulkParticipantsUpdate(jid, participants, action, onProgress?)` | Bulk admin operations |
| `groupGetAllAdmins(jid)` | List group admins |
